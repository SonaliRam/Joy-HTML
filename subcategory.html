<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Subcategory Dashboard</title>
    <link rel="stylesheet" href="./category.css" />
  </head>
  <body>
    <nav class="navbar">
      <div class="nav-container">
        <a href="Dashboard.html" class="logo">AdminPanel</a>
        <ul class="nav-menu">
          <li class="nav-item">
            <a href="Category.html">Category</a>
          </li>
          <li class="nav-item">
            <a href="subcategory.html">Sub-Category</a>
          </li>
          <li class="nav-item">
            <a href="#"> Products</a>
          </li>
          <li class="nav-item">
            <a href="#">Product Enquiry</a>
          </li>
          <li class="nav-item">
            <a href="#">Manage Users</a>
          </li>
          <li class="nav-item">
            <button class="logout" onclick="logout()">Logout</button>
          </li>
        </ul>
      </div>
    </nav>

    <div class="top-bar container">
      <h1 class="headings">Subcategory Dashboard</h1>
      <div class="top-controls">
        <button class="add-btn" onclick="openAddModal()">
          + Add Subcategory
        </button>
        <div id="subcategoryCount" class="category-count">
          Total Subcategories: 0
        </div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Category</th>
              <th>Published</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="subcategoryTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="addModal" class="modal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="headings" id="formTitle">Add Subcategory</h2>
          <span class="close-btn" onclick="closeAddModal()">&times;</span>
        </div>
        <form id="addForm" class="modal-form">
          <input type="hidden" id="subcategoryId" />

          <div class="form-group">
            <label>Name:</label>
            <input type="text" id="name" required />
          </div>

          <div class="form-group">
            <label>Description:</label>
            <textarea id="description"></textarea>
          </div>

          <div class="form-group">
            <label>Image Path (URL):</label>
            <input type="text" id="imagepath" />
          </div>

          <div class="form-group">
            <label>Meta Title:</label>
            <input type="text" id="metatitle" />
          </div>

          <div class="form-group">
            <label>Meta Description:</label>
            <textarea id="metadescription"></textarea>
          </div>

          <div class="form-group">
            <label>SEO Keywords:</label>
            <input type="text" id="seokeywords" />
          </div>

          <div class="form-group">
            <label>Publish Status:</label>
            <label
              ><input type="radio" name="ispublished" value="true" checked />
              Publish</label
            >
            <label
              ><input type="radio" name="ispublished" value="false" />
              Draft</label
            >
          </div>

          <div class="form-group">
            <label>Select Category:</label>
            <select id="categorySelect" required></select>
          </div>

          <div class="form-buttons">
            <button type="submit" class="btn-primary">Save</button>
            <button
              type="button"
              class="btn-secondary"
              onclick="closeAddModal()"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <script src="./Logout.js"></script>

    <script>
      const baseUrl = "http://localhost:8080/subcategories";
      const categoryUrl = "http://localhost:8080/categories";

      window.onload = () => {
        getAllSubcategories();
        loadCategories();
      };

      async function getAllSubcategories() {
        const res = await fetch(baseUrl);
        const data = await res.json();
        document.getElementById(
          "subcategoryCount"
        ).textContent = `Total Subcategories: ${data.length}`;
        const tableBody = document.getElementById("subcategoryTableBody");
        tableBody.innerHTML = "";
        data.forEach((sub) => {
          const row = document.createElement("tr");
          row.innerHTML = `
          <td>${sub.name}</td>
          <td>${sub.category?.name || "N/A"}</td>
          <td>${sub.ispublished ? "Yes" : "No"}</td>
          <td>
           <button class="edit-btn" data-sub='${encodeURIComponent(
             JSON.stringify(sub)
           )}' onclick="handleEditClick(this)"> Edit </button>

            <button class="delete-btn" onclick="deleteSubcategory(${
              sub.id
            })">Delete</button>
          </td>
        `;
          tableBody.appendChild(row);
        });
      }
      function handleEditClick(button) {
        const encoded = button.getAttribute("data-sub");
        const decoded = decodeURIComponent(encoded);
        const sub = JSON.parse(decoded);
        editSubcategory(sub);
      }

      function openAddModal() {
        document.getElementById("addModal").style.display = "flex";
        document.getElementById("addForm").reset();
        document.getElementById("subcategoryId").value = "";
        document.getElementById("formTitle").innerText = "Add Subcategory";
      }

      function closeAddModal() {
        document.getElementById("addModal").style.display = "none";
        document.getElementById("addForm").reset();
      }

      async function loadCategories() {
        const res = await fetch(categoryUrl);
        const categories = await res.json();
        const select = document.getElementById("categorySelect");
        select.innerHTML = categories
          .map((cat) => `<option value="${cat.id}">${cat.name}</option>`)
          .join("");
      }

      document
        .getElementById("addForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const id = document.getElementById("subcategoryId").value;
          const subcategory = {
            name: document.getElementById("name").value,
            description: document.getElementById("description").value,
            imagepath: document.getElementById("imagepath").value,
            metatitle: document.getElementById("metatitle").value,
            metadescription: document.getElementById("metadescription").value,
            seokeywords: document.getElementById("seokeywords").value,
            ispublished:
              document.querySelector('input[name="ispublished"]:checked')
                .value === "true",
            category: {
              id: parseInt(document.getElementById("categorySelect").value),
            },
          };

          const method = id ? "PUT" : "POST";
          const url = id ? `${baseUrl}/${id}` : baseUrl;

          console.log("Submitting:", JSON.stringify(subcategory, null, 2));

          await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(subcategory),
          });

          closeAddModal();
          getAllSubcategories();
        });

      function editSubcategory(sub) {
        document.getElementById("subcategoryId").value = sub.id;
        document.getElementById("name").value = sub.name;
        document.getElementById("description").value = sub.description;
        document.getElementById("imagepath").value = sub.imagepath;
        document.getElementById("metatitle").value = sub.metatitle;
        document.getElementById("metadescription").value = sub.metadescription;
        document.getElementById("seokeywords").value = sub.seokeywords;
        document.querySelector(
          `input[name="ispublished"][value="${sub.ispublished}"]`
        ).checked = true;
        document.getElementById("categorySelect").value =
          sub.category?.id || "";
        document.getElementById("formTitle").innerText = "Edit Subcategory";
        document.getElementById("addModal").style.display = "flex";
      }

      async function deleteSubcategory(id) {
        if (!confirm("Are you sure you want to delete this subcategory?"))
          return;
        await fetch(`${baseUrl}/${id}`, { method: "DELETE" });
        getAllSubcategories();
      }
    </script>
  </body>
</html>
